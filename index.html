<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GIF Background Remover - No Overlap Fix</title>
    
    <script src="https://cdn.jsdelivr.net/npm/omggif@1.0.10/omggif.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gifshot@0.4.5/build/gifshot.min.js"></script>

    <style>
        :root { --accent: #00ff88; --bg: #121212; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: white; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .container { max-width: 600px; width: 100%; background: #1e1e1e; padding: 25px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        #drop-zone { border: 2px dashed #444; padding: 30px; text-align: center; cursor: pointer; border-radius: 10px; margin-bottom: 20px; transition: 0.3s; background: rgba(255,255,255,0.02); }
        #drop-zone:hover { border-color: var(--accent); background: rgba(0,255,136,0.05); }

        .progress-box { margin: 20px 0; }
        #status { font-size: 13px; color: var(--accent); font-family: monospace; display: block; margin-bottom: 5px; }
        .bar-bg { width: 100%; height: 8px; background: #333; border-radius: 4px; overflow: hidden; }
        #bar-fill { width: 0%; height: 100%; background: var(--accent); transition: width 0.2s; }
        
        .previews { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        img { max-width: 100%; border: 1px solid #333; border-radius: 8px; min-height: 150px;
              background-image: linear-gradient(45deg, #252525 25%, transparent 25%), linear-gradient(-45deg, #252525 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #252525 75%), linear-gradient(-45deg, transparent 75%, #252525 75%);
              background-size: 12px 12px; background-position: 0 0, 0 6px, 6px -6px, -6px 0px; }

        .btn { background: var(--accent); color: #000; border: none; padding: 12px; border-radius: 6px; font-weight: bold; cursor: pointer; width: 100%; text-decoration: none; display: inline-block; text-align: center; margin-top: 15px; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="text-align: center; color: var(--accent); margin-top: 0;">GIF REMOVER <small style="font-size: 0.4em; opacity: 0.5;">ULTIMATE FIX</small></h2>
    
    <div id="drop-zone">Datei hierher ziehen oder klicken</div>
    <input type="file" id="file-input" style="display:none" accept="image/gif">

    <div class="progress-box">
        <span id="status">Initialisiere...</span>
        <div class="bar-bg"><div id="bar-fill"></div></div>
    </div>

    <div class="previews">
        <div style="text-align: center;"><small style="color:#888">ORIGINAL</small><br><img id="orig-view"></div>
        <div style="text-align: center;"><small style="color:#888">RESULTAT</small><br><img id="res-view"></div>
    </div>
    <a id="download-btn" class="btn" style="display:none">Download Transparent GIF</a>
</div>

<canvas id="canvas-task" style="display:none"></canvas>

<script>
    const status = document.getElementById('status');
    const bar = document.getElementById('bar-fill');
    const fileInput = document.getElementById('file-input');
    const resView = document.getElementById('res-view');
    const downloadBtn = document.getElementById('download-btn');

    // Sicherstellen, dass Libraries geladen sind
    function checkSystems() {
        if (typeof GifReader !== 'undefined' && typeof gifshot !== 'undefined') {
            status.innerText = "System bereit. Bitte GIF wählen.";
            return true;
        }
        status.innerText = "Lade Libraries... (Versuche Verbindung)";
        setTimeout(checkSystems, 500);
        return false;
    }
    checkSystems();

    document.getElementById('drop-zone').onclick = () => fileInput.click();

    fileInput.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        // Reset
        status.innerText = "Analysiere GIF...";
        bar.style.width = "0%";
        downloadBtn.style.display = "none";
        resView.src = "";
        document.getElementById('orig-view').src = URL.createObjectURL(file);

        try {
            const buffer = await file.arrayBuffer();
            const reader = new GifReader(new Uint8Array(buffer));
            const width = reader.width;
            const height = reader.height;
            const frameCount = reader.numFrames();
            
            const canvas = document.getElementById('canvas-task');
            const ctx = canvas.getContext('2d');
            canvas.width = width;
            canvas.height = height;

            const frames = [];

            for (let i = 0; i < frameCount; i++) {
                // 1. SCHRITT: Canvas komplett säubern (Wichtig gegen Überlagerung!)
                ctx.clearRect(0, 0, width, height);
                
                const imageData = ctx.createImageData(width, height);
                reader.decodeAndBlitFrameRGBA(i, imageData.data);
                
                const data = imageData.data;
                // Referenzfarbe vom ersten Pixel (Ecke oben links)
                const rRef = data[0], gRef = data[1], bRef = data[2];
                
                // 2. SCHRITT: Hintergrund entfernen
                for (let j = 0; j < data.length; j += 4) {
                    const diff = Math.abs(data[j] - rRef) + Math.abs(data[j+1] - gRef) + Math.abs(data[j+2] - bRef);
                    if (diff < 90) { // Schwellenwert für saubere Ränder
                        data[j+3] = 0; 
                    }
                }
                
                ctx.putImageData(imageData, 0, 0);
                frames.push(canvas.toDataURL('image/png'));
                
                bar.style.width = (10 + (i / frameCount) * 40) + "%";
                status.innerText = `Bereinige Frame ${i+1}/${frameCount}...`;
            }

            status.innerText = "Kodiere transparentes GIF...";
            
            gifshot.createGIF({
                images: frames,
                gifWidth: width,
                gifHeight: height,
                numFrames: frameCount,
                sampleInterval: 10,
                interval: 0.06,
                // 3. SCHRITT: Disposal Method 2 erzwingen (Verhindert Ghosting)
                renderingContext: {
                    disposal: 2 
                }
            }, function (obj) {
                if (obj.error) {
                    status.innerText = "Fehler: " + obj.errorMsg;
                } else {
                    status.innerText = "Fertig!";
                    bar.style.width = "100%";
                    resView.src = obj.image;
                    downloadBtn.href = obj.image;
                    downloadBtn.download = "no_background.gif";
                    downloadBtn.style.display = "block";
                }
            });

        } catch (err) {
            status.innerText = "Fehler: Datei konnte nicht verarbeitet werden.";
            console.error(err);
        }
    };
</script>
</body>
</html>
