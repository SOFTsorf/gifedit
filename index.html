<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GIF Background Remover Pro</title>
    <script src="https://unpkg.com/gif-ucto8@1.0.1/dist/gif-ucto8.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gifshot/0.4.5/gifshot.min.js"></script>
    <style>
        :root { --primary: #007bff; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; display: flex; flex-direction: column; align-items: center; padding: 40px; background: #1a1a1a; color: white; }
        
        .card { background: #2a2a2a; padding: 20px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); text-align: center; max-width: 800px; width: 100%; }
        
        #drop-zone { border: 3px dashed #444; padding: 40px; border-radius: 8px; cursor: pointer; transition: 0.3s; margin-bottom: 20px; }
        #drop-zone:hover { border-color: var(--primary); background: #333; }
        
        .progress-container { width: 100%; background: #444; height: 10px; border-radius: 5px; margin: 20px 0; display: none; overflow: hidden; }
        #progress-bar { width: 0%; height: 100%; background: var(--primary); transition: width 0.2s; }
        
        .preview-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .preview-box { background: #333; padding: 10px; border-radius: 8px; }
        
        img { max-width: 100%; border-radius: 4px; display: block; margin: 0 auto; }
        
        /* Transparenz-Indikator (Schachbrett) */
        .transparent-bg {
            background-image: linear-gradient(45deg, #3c3c3c 25%, transparent 25%), linear-gradient(-45deg, #3c3c3c 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #3c3c3c 75%), linear-gradient(-45deg, transparent 75%, #3c3c3c 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            background-color: #2a2a2a;
        }

        .btn { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; text-decoration: none; display: inline-block; margin-top: 10px; }
        .btn:disabled { background: #666; cursor: not-allowed; }
        
        canvas { display: none; }
        #status { margin-top: 10px; font-size: 0.9em; color: #aaa; }
    </style>
</head>
<body>

    <div class="card">
        <h2>GIF Background Remover</h2>
        <p>Lade dein GIF hoch, um den Hintergrund zu entfernen.</p>

        <div id="drop-zone">GIF hierher ziehen oder klicken</div>
        <input type="file" id="file-input" accept="image/gif" style="display: none;">

        <div class="progress-container" id="p-container">
            <div id="progress-bar"></div>
        </div>
        <div id="status">Bereit zum Verarbeiten...</div>

        <div class="preview-grid">
            <div class="preview-box">
                <small>Original</small>
                <img id="orig-view">
            </div>
            <div class="preview-box">
                <small>Ergebnis (Transparent)</small>
                <div class="transparent-bg">
                    <img id="res-view">
                </div>
                <a id="download-btn" class="btn" style="display: none;">Download GIF</a>
            </div>
        </div>
    </div>

    <canvas id="c"></canvas>

    <script>
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const status = document.getElementById('status');
        const progressBar = document.getElementById('progress-bar');
        const pContainer = document.getElementById('p-container');
        const resView = document.getElementById('res-view');
        const origView = document.getElementById('orig-view');
        const downloadBtn = document.getElementById('download-btn');
        const canvas = document.getElementById('c');
        const ctx = canvas.getContext('2d');

        dropZone.onclick = () => fileInput.click();
        fileInput.onchange = (e) => { if(e.target.files[0]) process(e.target.files[0]); };

        async function process(file) {
            // Reset UI
            status.innerText = "Initialisiere...";
            pContainer.style.display = "block";
            progressBar.style.width = "0%";
            resView.src = "";
            downloadBtn.style.display = "none";
            origView.src = URL.createObjectURL(file);

            const buffer = await file.arrayBuffer();
            const reader = new gifucto8.GifReader(new Uint8Array(buffer));
            const numFrames = reader.numFrames();
            const frames = [];

            canvas.width = reader.width;
            canvas.height = reader.height;

            // Phase 1: Frames bearbeiten
            for (let i = 0; i < numFrames; i++) {
                const imgData = ctx.createImageData(reader.width, reader.height);
                reader.decodeAndBlitFrameRGBA(i, imgData.data);
                
                // Hintergrund-Entfernung
                const processed = removeBg(imgData);
                ctx.putImageData(processed, 0, 0);
                
                frames.push(canvas.toDataURL('image/png'));
                
                // Fortschritt bis 50% (Processing Phase)
                let p = Math.round(((i + 1) / numFrames) * 50);
                progressBar.style.width = p + "%";
                status.innerText = `Bearbeite Frame ${i+1} von ${numFrames}...`;
            }

            // Phase 2: Encoding
            status.innerText = "Kodiere neues GIF... Bitte warten.";
            
            gifshot.createGIF({
                images: frames,
                gifWidth: reader.width,
                gifHeight: reader.height,
                interval: 0.05, // Schneller für flüssigere Animation
                numFrames: numFrames
            }, function (obj) {
                if (!obj.error) {
                    progressBar.style.width = "100%";
                    status.innerText = "Fertig!";
                    resView.src = obj.image;
                    downloadBtn.href = obj.image;
                    downloadBtn.download = "removed_background.gif";
                    downloadBtn.style.display = "inline-block";
                } else {
                    status.innerText = "Fehler beim Erstellen.";
                }
            });
        }

        function removeBg(imgData) {
            const data = imgData.data;
            // Wir nehmen die Farbe des Pixels (0,0) als Referenz (Hintergrund)
            const rRef = data[0], gRef = data[1], bRef = data[2];
            const threshold = 50; 

            for (let i = 0; i < data.length; i += 4) {
                const r = data[i], g = data[i+1], b = data[i+2];
                const diff = Math.sqrt((r-rRef)**2 + (g-gRef)**2 + (b-bRef)**2);
                
                if (diff < threshold) {
                    data[i+3] = 0; // Transparent machen
                }
            }
            return imgData;
        }
    </script>
</body>
</html>
