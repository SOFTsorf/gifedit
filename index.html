<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GIF Remover - Final Stable Version</title>
    
    <script src="https://cdn.jsdelivr.net/npm/omggif@1.0.10/omggif.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gifshot@0.4.5/build/gifshot.min.js"></script>

    <style>
        :root { --accent: #00ff88; --bg: #121212; --card: #1e1e1e; }
        body { font-family: 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: #eee; display: flex; flex-direction: column; align-items: center; padding: 20px; margin: 0; }
        .container { max-width: 700px; width: 100%; background: var(--card); padding: 30px; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.6); border: 1px solid #333; margin-top: 20px; }
        
        h2 { margin-top: 0; color: var(--accent); text-align: center; }
        
        #drop-zone { border: 2px dashed #444; padding: 40px; text-align: center; cursor: pointer; border-radius: 12px; transition: 0.3s; background: rgba(255,255,255,0.02); }
        #drop-zone:hover { border-color: var(--accent); background: rgba(0, 255, 136, 0.05); }

        .status-box { margin: 25px 0; }
        #status-text { font-size: 14px; font-weight: 600; color: var(--accent); display: block; margin-bottom: 8px; text-transform: uppercase; }
        
        .progress-bar-bg { width: 100%; height: 10px; background: #333; border-radius: 5px; overflow: hidden; }
        #progress-fill { width: 0%; height: 100%; background: linear-gradient(90deg, #00cc6e, var(--accent)); transition: width 0.3s; }
        
        .previews { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .preview-item { text-align: center; }
        .preview-item span { font-size: 11px; color: #888; display: block; margin-bottom: 5px; }
        
        img { max-width: 100%; border-radius: 8px; border: 1px solid #333; min-height: 150px; object-fit: contain;
              background-image: linear-gradient(45deg, #252525 25%, transparent 25%), linear-gradient(-45deg, #252525 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #252525 75%), linear-gradient(-45deg, transparent 75%, #252525 75%);
              background-size: 16px 16px; background-position: 0 0, 0 8px, 8px -8px, -8px 0px; }
        
        .btn { background: var(--accent); color: #121212; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; text-decoration: none; display: inline-block; margin-top: 15px; width: 100%; text-align: center; transition: 0.2s; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        
        #error-display { color: #ff4444; background: rgba(255, 68, 68, 0.1); padding: 15px; border-radius: 8px; margin-top: 20px; display: none; font-size: 13px; border: 1px solid rgba(255, 68, 68, 0.2); }
    </style>
</head>
<body>

<div class="container">
    <h2>GIF BG Remover</h2>
    
    <div id="drop-zone">
        <strong>GIF auswählen</strong><br>
        <span style="color: #888; font-size: 13px;">Klicken oder hierher ziehen</span>
    </div>
    <input type="file" id="file-input" style="display:none" accept="image/gif">

    <div class="status-box">
        <span id="status-text">Prüfe Libraries...</span>
        <div class="progress-bar-bg">
            <div id="progress-fill"></div>
        </div>
    </div>

    <div id="error-display"></div>

    <div class="previews">
        <div class="preview-item">
            <span>ORIGINAL</span>
            <img id="img-orig" alt="">
        </div>
        <div class="preview-item">
            <span>TRANSPARENT</span>
            <img id="img-res" alt="">
            <a id="dl-btn" class="btn" style="display:none">Download GIF</a>
        </div>
    </div>
</div>

<canvas id="work-canvas" style="display:none"></canvas>

<script>
    const statusText = document.getElementById('status-text');
    const progressFill = document.getElementById('progress-fill');
    const errorDisplay = document.getElementById('error-display');
    const fileInput = document.getElementById('file-input');
    const dlBtn = document.getElementById('dl-btn');

    // 1. Library Check
    function checkLibs() {
        const gifshotLoaded = typeof gifshot !== 'undefined';
        const omggifLoaded = typeof GifReader !== 'undefined';

        if (gifshotLoaded && omggifLoaded) {
            statusText.innerText = "Bereit zum Hochladen";
            return true;
        } else {
            let missing = !gifshotLoaded ? "gifshot " : "";
            missing += !omggifLoaded ? "omggif" : "";
            showError("Fehler: Library konnte nicht geladen werden (" + missing + "). Prüfe deine Internetverbindung.");
            return false;
        }
    }

    // Warte kurz, bis Libraries sicher geladen sind
    setTimeout(checkLibs, 1000);

    function showError(msg) {
        errorDisplay.innerText = msg;
        errorDisplay.style.display = 'block';
        statusText.innerText = "Fehler";
        progressFill.style.backgroundColor = "#ff4444";
    }

    function updateProgress(text, percent) {
        statusText.innerText = text;
        progressFill.style.width = percent + "%";
    }

    document.getElementById('drop-zone').onclick = () => fileInput.click();

    fileInput.onchange = async (e) => {
        if (!checkLibs()) return;
        
        const file = e.target.files[0];
        if (!file) return;

        // UI Reset
        errorDisplay.style.display = 'none';
        dlBtn.style.display = 'none';
        document.getElementById('img-res').src = "";
        document.getElementById('img-orig').src = URL.createObjectURL(file);
        progressFill.style.backgroundColor = "";

        try {
            updateProgress("Lese Datei...", 10);
            const buffer = await file.arrayBuffer();
            const reader = new GifReader(new Uint8Array(buffer));
            
            const { width, height } = reader;
            const numFrames = reader.numFrames();
            const canvas = document.getElementById('work-canvas');
            const ctx = canvas.getContext('2d', { willReadFrequently: true });
            
            canvas.width = width;
            canvas.height = height;
            const processedFrames = [];

            // Phase 1: Frames entpacken & BG entfernen
            for (let i = 0; i < numFrames; i++) {
                const imgData = ctx.createImageData(width, height);
                reader.decodeAndBlitFrameRGBA(i, imgData.data);
                
                // Hintergrund-Entfernung (erster Pixel als Referenz)
                const d = imgData.data;
                const rR = d[0], gR = d[1], bR = d[2];
                
                for (let j = 0; j < d.length; j += 4) {
                    // Farbdifferenz berechnen
                    const diff = Math.abs(d[j]-rR) + Math.abs(d[j+1]-gR) + Math.abs(d[j+2]-bR);
                    if (diff < 70) d[j+3] = 0; // Transparenz setzen
                }
                
                ctx.putImageData(imgData, 0, 0);
                processedFrames.push(canvas.toDataURL('image/png'));
                
                let p = 10 + Math.round((i / numFrames) * 40);
                updateProgress(`Verarbeite Frame ${i+1}/${numFrames}`, p);
            }

            // Phase 2: Neues GIF zusammenbauen
            updateProgress("Generiere GIF (Encoding)...", 60);
            
            gifshot.createGIF({
                images: processedFrames,
                gifWidth: width,
                gifHeight: height,
                numFrames: numFrames,
                sampleInterval: 10,
                interval: 0.06 // Geschwindigkeit
            }, function (obj) {
                if (obj.error) {
                    showError("Encoding Fehler: " + obj.errorMsg);
                } else {
                    updateProgress("Fertig!", 100);
                    document.getElementById('img-res').src = obj.image;
                    dlBtn.href = obj.image;
                    dlBtn.download = "transparent_animation.gif";
                    dlBtn.style.display = "block";
                }
            });

        } catch (err) {
            showError("Kritischer Fehler: " + err.message);
        }
    };
</script>
</body>
</html>
